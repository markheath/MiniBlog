<post>
  <title>How to Resample Audio with NAudio</title>
  <slug>how-to-resample-audio-with-naudio</slug>
  <author>Mark Heath</author>
  <pubDate>2014-05-12 17:40:00</pubDate>
  <lastModified>2014-05-12 17:40:12</lastModified>
  <content>&lt;p&gt;Every now and then you’ll find you need to resample audio with NAudio. For example, to mix files together of different sample rates, you need to get them all to a common sample rate first. Or if you’re playing audio through an API like WASAPI, which doesn’t resample for you, you need to do this yourself (actually WasapiOut in NAudio does include a resampling step on your behalf if needed).&lt;/p&gt; &lt;p&gt;There are also some gotchas you need to be aware of when resampling. In particular there is the danger of “aliasing”. I explain what this is in my Pluralsight “&lt;a href="http://pluralsight.com/training/Courses/TableOfContents/digital-audio-fundamentals"&gt;Digital Audio Fundamentals&lt;/a&gt;” course. The main takeaway is that if you lower the sample rate, you really ought to use a low pass filter first, to get rid of high frequencies that cannot correctly. &lt;/p&gt; &lt;h3&gt;Option 1: Media Foundation Resampler&lt;/h3&gt; &lt;p&gt;Probably the most powerful resampler available with NAudio is the MediaFoundationResampler. This is not available for XP users, but desktop versions of Windows from Vista onwards include it. If you are using a Windows Server, you’ll need to make sure the desktop experience is installed. It has a customisable quality level (60 is the highest quality, down to 1 which is linear interpolation). I’ve found it’s fast enough to run on top quality. It also is quite flexible and is often able to change to a different channel count or bit depth at the same time.&lt;/p&gt; &lt;p&gt;Here;s a code sample that resamples an MP3 file (usually 44.1kHz) down to 16kHz. The MediaFoundationResampler takes an IWaveProvider as input, and a desired output format:&lt;/p&gt;&lt;pre class="brush: csharp;"&gt;int outRate = 16000;
var inFile = @"test.mp3";
var outFile = @"test resampled MF.wav";
using (var reader = new Mp3FileReader(inFile))
{
    var outFormat = new WaveFormat(outRate,    reader.WaveFormat.Channels);
    using (var resampler = new MediaFoundationResampler(reader, outFormat))
    {
        // resampler.ResamplerQuality = 60;
        WaveFileWriter.CreateWaveFile(outFile, resampler);
    }
}
&lt;/pre&gt;
&lt;h3&gt;Option 2: Wdl Resampling Sample Provider&lt;/h3&gt;
&lt;p&gt;The second option is even newer, and was added as part of NAudio 1.7.1. It’s based on the &lt;a href="http://www.cockos.com/wdl/"&gt;Cockos WDL&lt;/a&gt; resampler for which we were kindly granted permission to use as part of NAudio. It works with floating point samples, so you’ll need an ISampleProvider to pass in. Here we use AudioFileReader to get to floating point and then make a resampled 16 bit WAV file:&lt;/p&gt;&lt;pre class="brush: csharp;"&gt;int outRate = 16000;
var inFile = @"test.mp3";
var outFile = @"test resampled WDL.wav";
using (var reader = new AudioFileReader(inFile))
{
    var resampler = new WdlResamplingSampleProvider(reader, outRate);
    WaveFileWriter.CreateWaveFile16(outFile, resampler);
}
&lt;/pre&gt;
&lt;p&gt;The big advantage that the WDL resampler brings to the table is that it is fully managed. This means it can be used within Windows Store apps (as I’m still finding it very difficult to work out how to create the MediaFoundationResampler in a way that passes WACK).&lt;/p&gt;
&lt;h3&gt;Option 3: ACM Resampler&lt;/h3&gt;
&lt;p&gt;You can also use WaveFormatConversionStream which is an ACM based Resampler, which has been in NAudio since the beginning and works back to Windows XP. It resamples 16 bit only and you can’t change the channel count at the same time. It predates IWaveProvider so you need to pass in a WaveStream based. Here’s it being used to resample an MP3 file:&lt;/p&gt;&lt;pre class="brush: csharp;"&gt;int outRate = 16000;
var inFile = @"test.mp3";
var outFile = @"test resampled ACM.wav";
using (var reader = new Mp3FileReader(inFile))
{
    var outFormat = new WaveFormat(outRate,    reader.WaveFormat.Channels);
    using (var resampler = new WaveFormatConversionStream(outFormat, reader))
    {
        WaveFileWriter.CreateWaveFile(outFile, resampler);
    }
}
&lt;/pre&gt;
&lt;h3&gt;Option 4: Do it yourself&lt;/h3&gt;
&lt;p&gt;Of course the fact that NAudio lets you have raw access to the samples means you are able to write your own resampling algorithm, which could be Linear Interpolation or something more complex. I’d recommend against doing this unless you really understand audio DSP. If you want to see some spectograms showing what happens when you write your own naive resampling algorithm, have a look at &lt;a href="http://www.codeproject.com/Articles/501521/How-to-convert-between-most-audio-formats-in-NET"&gt;this article&lt;/a&gt; I wrote on CodeProject. Basically, you’re likely to end up with significant aliasing if you don’t also write a low pass filter. Given NAudio now has the WDL resampler, that should probably be used for all cases where you need a fully managed resampler.&lt;/p&gt;
&lt;p&gt;If you’re a Pluralsight subscriber, you can watch me doing some resampling in Module 4 of my “&lt;a href="http://pluralsight.com/training/Courses/TableOfContents/audio-programming-naudio"&gt;Audio Programming with NAudio&lt;/a&gt;” course&lt;/p&gt;  </content>
  <ispublished>true</ispublished>
  <categories>
    <category>NAudio</category>
    <category>audio</category>
  </categories>
  <comments />
</post>