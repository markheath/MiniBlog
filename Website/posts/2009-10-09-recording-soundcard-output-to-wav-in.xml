<post>
  <title>Recording the Soundcard Output to WAV in NAudio</title>
  <slug>recording-soundcard-output-to-wav-in</slug>
  <author>Mark Heath</author>
  <pubDate>2009-10-09 07:35:00</pubDate>
  <lastModified>2010-10-04 21:30:35</lastModified>
  <content>Suppose you want to not just play back some audio, but record what you are playing to a WAV file. This can be achieved in &lt;a href="http://www.codeplex.com/naudio" target="_blank"&gt;NAudio&lt;/a&gt; by creating an IWaveProvider whose read method reads from another IWaveProvider but also writes to disk as it goes. This is very easy to implement, and the WaveRecorder class I present here will be added to NAudio shortly. Our WaveRecorder also needs to be disposable, as we will want to close the WAV file when we are finished.&lt;br&gt;
&lt;pre class="brush: csharp"&gt;/// &amp;lt;summary&amp;gt;
/// Utility class to intercept audio from an IWaveProvider and
/// save it to disk
/// &amp;lt;/summary&amp;gt;
public class WaveRecorder : IWaveProvider, IDisposable
{
    private WaveFileWriter writer;
    private IWaveProvider source;
 
    /// &amp;lt;summary&amp;gt;
    /// Constructs a new WaveRecorder
    /// &amp;lt;/summary&amp;gt;
    /// &amp;lt;param name="destination"&amp;gt;The location to write the WAV file to&amp;lt;/param&amp;gt;
    /// &amp;lt;param name="source"&amp;gt;The source Wave Provider&amp;lt;/param&amp;gt;
    public WaveRecorder(IWaveProvider source, string destination)
    {
        this.source = source;
        this.writer = new WaveFileWriter(destination, source.WaveFormat);
    }
     
    /// &amp;lt;summary&amp;gt;
    /// Read simply returns what the source returns, but writes to disk along the way
    /// &amp;lt;/summary&amp;gt;
    public int Read(byte[] buffer, int offset, int count)
    {
        int bytesRead = source.Read(buffer, offset, count);
        writer.WriteData(buffer, offset, bytesRead);
        return bytesRead;
    }
 
    /// &amp;lt;summary&amp;gt;
    /// The WaveFormat
    /// &amp;lt;/summary&amp;gt;
    public WaveFormat WaveFormat
    {
        get { return source.WaveFormat; }
    }
 
    /// &amp;lt;summary&amp;gt;
    /// Closes the WAV file
    /// &amp;lt;/summary&amp;gt;
    public void Dispose()
    {
        if (writer != null)
        {
            writer.Dispose();
            writer = null;
        }
    }
}&lt;/pre&gt;
&lt;br&gt;
Now we have our WaveRecorder, we can insert it anywhere in the chain we like. The most obvious place is right at the end of the chain. So we wrap the WaveStream or WaveProvider we would normally pass to the Init method of our IWavePlayer with the WaveRecorder class. To demonstrate, I will extend the &lt;a href="/post/playback-of-sine-wave-in-naudio"&gt;sine wave generating code&lt;/a&gt; I created recently, to save the sine wave you are playing to disk. Only three extra lines of code are required:&lt;br&gt;
&lt;pre class="brush: csharp;"&gt;IWavePlayer waveOut;
WaveRecorder recorder; 

private void button1_Click(object sender, EventArgs e)
{
    StartStopSineWave();
}

void StartStopSineWave()
{
    if (waveOut == null)
    {
        var sineWaveProvider = new SineWaveProvider16();
        sineWaveProvider.SetWaveFormat(16000, 1); // 16kHz mono
        sineWaveProvider.Frequency = 500;
        sineWaveProvider.Amplitude = 0.1f;
        recorder = new WaveRecorder(sineWaveProvider, @"C:\Users\Mark\Documents\sine.wav");
        waveOut = new WaveOut();
        waveOut.Init(recorder);
        waveOut.Play();
    }
    else
    {
        waveOut.Stop();
        waveOut.Dispose();
        waveOut = null;
        recorder.Dispose();
        recorder = null;                
    }
}&lt;/pre&gt;</content>
  <ispublished>true</ispublished>
  <categories>
    <category>NAudio</category>
    <category>audio</category>
  </categories>
  <comments>
    <comment isAdmin="false" isApproved="true" id="1d6e06d0-4fd2-403b-8141-3dc74160dd48">
      <author>n2o</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/13671312541131264818</website>
      <ip />
      <userAgent />
      <date>2009-10-09 18:55:50</date>
      <content>I have a problem with this.&lt;br /&gt;&amp;quot;LineOutRecorder.WaveRecorder&amp;#39; does not implement interface member &amp;#39;NAudio.Wave.IWaveProvider.Read(NAudio.Wave.IWaveBuffer)&amp;quot;&lt;br /&gt;Source:&lt;br /&gt;http://www.paste.lt/paste/879522bf8c12bb7e6c6a7ab7eaad9d22&lt;br /&gt;Sollution explorer screenshot:&lt;br /&gt;http://i647.photobucket.com/albums/uu198/n2oo/sollution.png</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="5c3505fe-56aa-4b97-b6b9-6a71999d8354">
      <author>Mark H</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/17900587357903273800</website>
      <ip />
      <userAgent />
      <date>2009-10-09 19:05:53</date>
      <content>hi n20,&lt;br /&gt;have you got the very latest NAudio source code out from Codeplex?</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="6775ab36-67fe-49ec-a3bf-f958372958e9">
      <author>Mark H</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/17900587357903273800</website>
      <ip />
      <userAgent />
      <date>2009-10-09 19:05:54</date>
      <content>This comment has been removed by the author.</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="81623b71-7557-4736-b21a-c2e3cf055a40">
      <author>n2o</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/13671312541131264818</website>
      <ip />
      <userAgent />
      <date>2009-10-09 19:32:35</date>
      <content>Version that I tried I downloaded today from Codeplex.</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="51bc9064-7c95-45b3-84b7-82fa8aff29ca">
      <author>Mark H</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/17900587357903273800</website>
      <ip />
      <userAgent />
      <date>2009-10-09 19:43:11</date>
      <content>You need to go to the source code tab and download the latest and build it. NAudio 1.3 has not yet been released yet.&lt;br /&gt;&lt;br /&gt;Here&amp;#39;s the code for the latest IWaveProvider:&lt;br /&gt;http://naudio.codeplex.com/sourcecontrol/changeset/view/28979?projectName=naudio#258022</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="0a01d3de-b599-4289-a381-2c082ae46a56">
      <author>Jelle</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/15856997623929235688</website>
      <ip />
      <userAgent />
      <date>2009-10-09 20:22:24</date>
      <content>Hi Mark,&lt;br /&gt;&lt;br /&gt;I would like to record only the audio from one single application that plays music. is that possible with the NAUDIO lib ?&lt;br /&gt;&lt;br /&gt;thanks!&lt;br /&gt;&lt;br /&gt;Jelle</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="c89d48c4-4acd-48c5-ae93-aec453e07bf3">
      <author>n2o</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/13671312541131264818</website>
      <ip />
      <userAgent />
      <date>2009-10-10 11:33:46</date>
      <content>This comment has been removed by the author.</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="248c2fcf-fe25-4618-bac1-0c04f1dc1cb3">
      <author>n2o</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/13671312541131264818</website>
      <ip />
      <userAgent />
      <date>2009-10-10 13:29:47</date>
      <content>Thank You for replay Mark,&lt;br /&gt;Here I found nice recording application example:&lt;br /&gt;http://opensebj.blogspot.com/2009/04/naudio-tutorial-5-recording-audio.html&lt;br /&gt;&lt;br /&gt;Is it possible to programmicaly select the recording device? (choose between mic, line-in and wave etc.)</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="488b9c56-ce6f-4ff4-9c78-fd9b0fd4f596">
      <author>n2o</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/13671312541131264818</website>
      <ip />
      <userAgent />
      <date>2009-10-10 13:57:57</date>
      <content>BTW I am using XP, seems that newest NAudio Demo has that function but as exeption said &amp;quot;This functionality is only supported on Windows Vista or newer.&amp;quot;&lt;br /&gt;&lt;br /&gt;One more question about recorder buffer, it contais bytes, so each audio sample is 8bit or divided into several array elements?</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="0e4b9dff-85f0-4488-a484-9cf85ebafba5">
      <author>Mark H</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/17900587357903273800</website>
      <ip />
      <userAgent />
      <date>2009-10-10 14:28:15</date>
      <content>hi n2o, you can&amp;#39;t use WASAPI capture on XP. Use WaveIn instead. See my voice recorder article on the Coding4Fun website to learn more about recording audio in NAudio.&lt;br /&gt;&lt;br /&gt;http://blogs.msdn.com/coding4fun/archive/2009/10/08/9905168.aspx</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="6d1433d7-b21b-4bc9-a80b-2616b9ee63b9">
      <author>JC</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/00480996145824505367</website>
      <ip />
      <userAgent />
      <date>2010-05-20 08:57:29</date>
      <content>Hi Mark! I&amp;#39;m on Windows 7 and am struggling to get NAudio to record the stereo mix - is this possible, maybe using WASAPI as opposed to WaveIn? I&amp;#39;m not sure how to do this with NAudio if it is.&lt;br /&gt;&lt;br /&gt;I&amp;#39;ve used the tutorial example 5 from Codeplex and clicked the &amp;quot;Record all output from my soundcard&amp;quot; button, but it only records what is coming in from the microphone. Any pointers would be greatly appreciated!! Many thanks.</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="01547d7b-1de1-408a-8c09-2232baca5302">
      <author>Mark H</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/17900587357903273800</website>
      <ip />
      <userAgent />
      <date>2010-05-21 10:56:30</date>
      <content>hi JC, it probably depends on your sound-card drivers whether any of the WaveIn options can do this programatically. You might need to get the windows mixer up to select your recording source to make it work.</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="fd6f9657-f02e-4c45-9fe4-9fc84e8b5708">
      <author>JIbin</author>
      <email>noreply@blogger.com</email>
      <website />
      <ip />
      <userAgent />
      <date>2010-11-01 10:17:04</date>
      <content>HI,&lt;br /&gt;Now i am able to capture sound and at the same time i send it over network like this&lt;br /&gt;&lt;br /&gt; &lt;br /&gt;&lt;br /&gt;private void waveIn_DataAvailable(object sender, WaveInEventArgs e)&lt;br /&gt;        {          &lt;br /&gt;            byte[] buffer = e.Buffer;&lt;br /&gt;&lt;br /&gt;            byte[] dataToWrite = ALawEncoder.ALawEncode(buffer);&lt;br /&gt;&lt;br /&gt;            if (socket_Audio != null)&lt;br /&gt;                socket_Audio.SendTo(dataToWrite, new IPEndPoint(IPAddress.Parse(RemoteIpv6), SoundPort));&lt;br /&gt;       &lt;br /&gt;        }&lt;br /&gt;&lt;br /&gt; &lt;br /&gt;&lt;br /&gt;Now the  problem that i am facing is how to get back this audio at receiving end and and send it to the speaker of the system&lt;br /&gt;&lt;br /&gt;I am just starting a new thread for rxving data from network&lt;br /&gt;&lt;br /&gt;  myAudioThread = new Thread(new ThreadStart(AudioListener));&lt;br /&gt;  myAudioThread.Start();&lt;br /&gt;&lt;br /&gt;And in the AudioListener() i use the following code&lt;br /&gt;&lt;br /&gt; #region for Audio socket Its rxving audio always&lt;br /&gt;          &lt;br /&gt;            try&lt;br /&gt;            {&lt;br /&gt;&lt;br /&gt;                socket_Audio = new Socket(AddressFamily.InterNetworkV6, SocketType.Dgram, ProtocolType.Udp);&lt;br /&gt;&lt;br /&gt;                socket_Audio.Bind(new IPEndPoint(IPAddress.IPv6Any, SoundPort));&lt;br /&gt;                IPEndPoint remoteEP = new IPEndPoint(IPAddress.IPv6Any, SoundPort);&lt;br /&gt;                    //Receive data.&lt;br /&gt;                   &lt;br /&gt;                byte[] byteData;&lt;br /&gt;                while (true)&lt;br /&gt;                {&lt;br /&gt;&lt;br /&gt;                    byteData = new byte[2048];&lt;br /&gt;                    //Receive data.&lt;br /&gt;                    socket_Audio.Receive(byteData);&lt;br /&gt;                    &lt;br /&gt;                    //G711 compresses the data by 50%, so we allocate a buffer of double&lt;br /&gt;                    //the size to store the decompressed data.&lt;br /&gt;                    byte[] byteDecodedData = new byte[byteData.Length * 2];&lt;br /&gt;&lt;br /&gt;                    //Decompress data using the proper vocoder.&lt;br /&gt;                    &lt;br /&gt;                    ALawDecoder.ALawDecode(byteData, out byteDecodedData);&lt;br /&gt;&lt;br /&gt;                  &lt;br /&gt;&lt;br /&gt;                }&lt;br /&gt;&lt;br /&gt;Now the decoded audio is in the byte array byteDecodedData.How i send it to speaker of that system.&lt;br /&gt;&lt;br /&gt;I found only waveOut.Play()  and&lt;br /&gt;&lt;br /&gt; public override int Read(byte[] buffer, int offset, int count)&lt;br /&gt; {&lt;br /&gt;&lt;br /&gt;   //code to process data&lt;br /&gt;&lt;br /&gt; }&lt;br /&gt;&lt;br /&gt;  in the examples&lt;br /&gt;&lt;br /&gt;Pls guide me to the next step....Pls let me know if i am in wrong path.&lt;br /&gt;&lt;br /&gt;Thanks&lt;br /&gt;&lt;br /&gt;JIbin&lt;br /&gt;&lt;br /&gt;jibin.mn@hotmail.com</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="30cf49f6-aff7-4fd7-9bca-6a90c686246f">
      <author>Mark H</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/17900587357903273800</website>
      <ip />
      <userAgent />
      <date>2010-11-08 08:09:10</date>
      <content>@Jlbin - have a look at the BufferedWaveProvider in the latest code. This can be used to buffer up your data read from the network and can be used to feed the soundcard</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="dc53a35d-35bd-4659-a1b9-022dbe280684">
      <author>Seingalt</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/16456458870858627914</website>
      <ip />
      <userAgent />
      <date>2010-11-11 01:38:07</date>
      <content>Hi Mark,&lt;br /&gt;&lt;br /&gt;Great lib by the way.&lt;br /&gt;&lt;br /&gt;I just want to ask if you have any ideas about recording conversations?&lt;br /&gt;&lt;br /&gt;Is it possible to capture it using WASAPI or, in my case since I&amp;#39;m using win XP, WaveIn? Or do you know any alternatives to that? &lt;br /&gt;&lt;br /&gt;seemenomore1987@gmail.com</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="71645f2d-8f4b-4db2-9d45-2342de25facc">
      <author>Mark H</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/17900587357903273800</website>
      <ip />
      <userAgent />
      <date>2010-11-11 10:13:38</date>
      <content>@Seingalt what do you mean by conversations? conversations on what program? if you mean skype, then you could look into using the Skype4Com object</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="e3b58a4b-1b31-46d0-b141-cdc298f77935">
      <author>Seingalt</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/16456458870858627914</website>
      <ip />
      <userAgent />
      <date>2010-11-12 07:22:08</date>
      <content>Hi Mark,&lt;br /&gt;&lt;br /&gt;I&amp;#39;d take a look at skype4com objects. &lt;br /&gt;&lt;br /&gt;Basically, I have a web application that should allow the user to call (for example a Call Center Rep.) from that page and record that conversation.&lt;br /&gt;&lt;br /&gt;I have done some research on skype4com already but somehow I&amp;#39;m still having a hard time on how I could use it on my application.&lt;br /&gt;&lt;br /&gt;If you know or have any articles about it just post it here. Like &amp;quot;Using skype4com objects in your web application for biginners&amp;quot; &lt;br /&gt;&lt;br /&gt;Thanks!</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="c5ed3e79-8914-4072-a2d9-95544d62e847">
      <author>Mark H</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/17900587357903273800</website>
      <ip />
      <userAgent />
      <date>2010-11-15 13:31:20</date>
      <content>@Seingalt - check my Coding4Fun article and project - &lt;a href="http://skypefx.codeplex.com" rel="nofollow"&gt;SkypeFx&lt;/a&gt;</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="b5dfaaa0-c7b2-4498-8ffe-6aedbc2f3c14">
      <author>Anonymous</author>
      <email>noreply@blogger.com</email>
      <website />
      <ip />
      <userAgent />
      <date>2010-11-16 11:10:28</date>
      <content>Thanks for the great example. I already noticed it at NAudio but since it was not actually used in tehir code, the sample was very helpful.&lt;br /&gt;&lt;br /&gt;One question: I would like to use the WaveRecorder combined with the ASIO4All. The NADIO Asio only has AsioOut.cs. Is there a sample of how the Wave Recorder is used for ASIO?&lt;br /&gt;&lt;br /&gt;Thanks&lt;br /&gt;HM</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="e7434793-d7cf-48bc-8c26-1a66c3dffde5">
      <author>Mark H</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/17900587357903273800</website>
      <ip />
      <userAgent />
      <date>2010-11-16 11:37:51</date>
      <content>sadly NAudio ASIO support is very basic and doesn&amp;#39;t work with all soundcards at the moment</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="ff910de5-aeb1-44ad-aa47-749151e706cc">
      <author>Anonymous</author>
      <email>noreply@blogger.com</email>
      <website />
      <ip />
      <userAgent />
      <date>2010-11-16 14:30:58</date>
      <content>Thanks Mark. I&amp;#39;m still hopefull, and struggeling with adding the ASIO-in interface by myself. I&amp;#39;m  trying to figure out where to fit the WaveRecorder class.&lt;br /&gt;Since WaveRecorder is actually an IWaveProvider, I plan to add AsioIn.cs which has &amp;quot;recordStream&amp;quot; of class WaveRecord (similar to AsioOut). I&amp;#39;m jyust confused wehther or not I need to add IWaveRecorder, similar to IWavePlayer.&lt;br /&gt;&lt;br /&gt;Thanks you very much!&lt;br /&gt;HM</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="f5d9a83d-eb73-43b6-9807-6ec727a99be7">
      <author>Mark H</author>
      <email>noreply@blogger.com</email>
      <website>http://www.blogger.com/profile/17900587357903273800</website>
      <ip />
      <userAgent />
      <date>2010-11-24 15:07:39</date>
      <content>@HM, an AsioIn class should implement IWaveIn</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="5df18f43-e9fb-42bf-8427-8c4e106633cd">
      <author>Anonymous</author>
      <email>noreply@blogger.com</email>
      <website />
      <ip />
      <userAgent />
      <date>2011-01-18 14:31:38</date>
      <content>Can I use that source code on windows mobile? Or do you have a code that record a wave file format on windows mobile? (records in a wave file format ..)</content>
    </comment>
    <comment isAdmin="false" isApproved="true" id="e79647a8-f66a-4953-a46b-5b783c9ef355">
      <author>Anonymous</author>
      <email>noreply@blogger.com</email>
      <website />
      <ip />
      <userAgent />
      <date>2012-11-12 12:50:18</date>
      <content>I want to change the frequency of this sinus wave without interrupting it and quite quickly . You said in your previous posts that I need to do it smoothly , how can I do that ? Sorry but I&amp;#39;m a beginner</content>
    </comment>
  </comments>
</post>